machine:
  pre:
    # Manually install docker 1.8.3 until CircleCI ships it per default
    - echo 'DOCKER_OPTS="-s btrfs -e lxc -D --userland-proxy=false"' | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker 'https://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.3-circleci'
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker

dependencies:
  cache_directories:
    - "~/.hex/packages"
  pre:
    - mkdir -p $HOME/tmp && cd $HOME/tmp
    - wget https://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb && sudo dpkg -i erlang-solutions_1.0_all.deb
    - sudo apt-get update
    - sudo apt-get install -y elixir
  override:
    - mix local.hex --force
    - mix local.rebar --force
    - mix archive.install --force http://git.io/edib-0.5.0.ez
    - mix local
  post:
    - docker pull edib/edib-tool:1.0

test:
  pre:
    - docker version
    - cd $HOME/$CIRCLE_PROJECT_REPONAME
    - ls -ahlF
  override:
    - mix edib --no-rm --prefix circleci
